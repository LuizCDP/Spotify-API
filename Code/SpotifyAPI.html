<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Login Spotify e perfil</title>
<style>
  body { font-family: Arial, sans-serif; margin: 2rem; background-color: #121212; color: white; }
  #profile { margin-top: 20px; }
  #profile img { border-radius: 50%; width: 150px; height: 150px; }
</style>
<style>

  #profile {
    margin-top: 20px;
    padding: 15px;
    border: 2px solid #1ED760;
    border-radius: 8px;
    background-color: #0e0e0e;
    width: auto;
    transition: border 1s;
  }

  #profile:hover {
    border: 2px solid #8c00ff;
  }

</style>
</head>
<body>
  <img src="https://storage.googleapis.com/pr-newsroom-wp/1/2018/11/Spotify_Logo_CMYK_Green.png" alt="Spotify Logo" width="200" />
<h1>Login com Spotify e mostra perfil</h1>
<button id="loginBtn">Login no Spotify</button>

<div id="profile" style="display: none;">
  <h2>Perfil do UsuÃ¡rio</h2>
  <img id="avatar" src="" alt="Foto do perfil" />
  <p><strong>Nome:</strong> <span id="name"></span></p>
  <p><strong>Email:</strong> <span id="email"></span></p>
  <p><strong>ID:</strong> <span id="id"></span></p>
  <p><strong>Seguidores:</strong> <span id="followers"></span></p>
  <p><strong>Tipo conta:</strong> <span id="product"></span></p>
</div>

<script>
// === CONFIG ===
const clientId = '772fc8c550134664ac364248da287c08';
const redirectUri = window.location.origin + window.location.pathname;
const scopes = 'user-read-private user-read-email user-read-playback-state';

// Utils PKCE
function generateRandomString(length) {
  const possible = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
  let text = '';
  for(let i=0; i<length; i++) {
    text += possible.charAt(Math.floor(Math.random() * possible.length));
  }
  return text;
}

async function sha256(plain) {
  const encoder = new TextEncoder();
  const data = encoder.encode(plain);
  const hashBuffer = await crypto.subtle.digest('SHA-256', data);
  return new Uint8Array(hashBuffer);
}

function base64urlencode(buffer) {
  let base64 = btoa(String.fromCharCode(...buffer));
  return base64.replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/, '');
}

async function generateCodeChallenge(codeVerifier) {
  const hashed = await sha256(codeVerifier);
  return base64urlencode(hashed);
}

// Iniciar login
document.getElementById('loginBtn').onclick = async () => {
  const codeVerifier = generateRandomString(128);
  const codeChallenge = await generateCodeChallenge(codeVerifier);
  sessionStorage.setItem('code_verifier', codeVerifier);

  const args = new URLSearchParams({
    response_type: 'code',
    client_id: clientId,
    scope: scopes,
    redirect_uri: redirectUri,
    code_challenge_method: 'S256',
    code_challenge: codeChallenge,
  });

  window.location = 'https://accounts.spotify.com/authorize?' + args;
};

// Obter parÃ¢metros da URL
function getQueryParams() {
  return new URLSearchParams(window.location.search);
}

async function getAccessToken(code) {
  const codeVerifier = sessionStorage.getItem('code_verifier');

  const body = new URLSearchParams({
    client_id: clientId,
    grant_type: 'authorization_code',
    code: code,
    redirect_uri: redirectUri,
    code_verifier: codeVerifier,
  });

  const response = await fetch('https://accounts.spotify.com/api/token', {
    method: 'POST',
    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
    body: body.toString(),
  });

  if (!response.ok) {
    throw new Error('Erro ao pegar token: ' + response.status);
  }
  return response.json();
}

async function getUserProfile(accessToken) {
  const response = await fetch('https://api.spotify.com/v1/me', {
    headers: { Authorization: 'Bearer ' + accessToken }
  });
  if (!response.ok) throw new Error('Erro ao pegar perfil: ' + response.status);
  return response.json();
}

async function getCurrentPlayingTrack(accessToken) {
  const response = await fetch('https://api.spotify.com/v1/me/player/currently-playing', {
    headers: { Authorization: 'Bearer ' + accessToken }
  });

  if (response.status === 204) return null; // Nada tocando
  if (!response.ok) throw new Error('Erro ao buscar mÃºsica: ' + response.status);
  return response.json();
}

async function main() {
  const params = getQueryParams();

  if (params.has('code')) {
    const code = params.get('code');

    try {
      const tokenData = await getAccessToken(code);

      // Limpa URL
      window.history.replaceState({}, document.title, redirectUri);

      const profile = await getUserProfile(tokenData.access_token);
      const music = await getCurrentPlayingTrack(tokenData.access_token);

      document.getElementById('loginBtn').style.display = 'none';
      document.getElementById('profile').style.display = 'block';

      // Dados do perfil
      document.getElementById('name').textContent = profile.display_name || 'NÃ£o disponÃ­vel';
      document.getElementById('email').textContent = profile.email || 'NÃ£o disponÃ­vel';
      document.getElementById('id').textContent = profile.id || 'NÃ£o disponÃ­vel';
      document.getElementById('followers').textContent = profile.followers?.total || '0';
      document.getElementById('product').textContent = profile.product || 'NÃ£o disponÃ­vel';
      if (profile.images && profile.images.length > 0) {
        document.getElementById('avatar').src = profile.images[0].url;
      } else {
        document.getElementById('avatar').alt = 'Sem foto';
      }

      // MÃºsica atual
      if (music && music.item) {
        const song = music.item;
        const songHtml = `
          <h2>ðŸŽµ MÃºsica tocando agora</h2>
          <img src="${song.album.images[0].url}" width="200" />
          <p><strong>${song.name}</strong> - ${song.artists.map(a => a.name).join(', ')}</p>
          <iframe src="https://open.spotify.com/embed/track/${song.id}" width="300" height="80" frameborder="0" allowtransparency="true" allow="encrypted-media"></iframe>
        `;
        const div = document.createElement('div');
        div.innerHTML = songHtml;
        document.getElementById('profile').appendChild(div);
      } else {
        const noMusic = document.createElement('p');
        noMusic.textContent = 'Nenhuma mÃºsica tocando no momento.';
        document.getElementById('profile').appendChild(noMusic);
      }

    } catch (error) {
      alert('Erro: ' + error.message);
    }
  }
}

main();
</script>

</body>
</html>